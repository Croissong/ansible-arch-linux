---
- name: create partition table on device
  parted: 
    device: {{ disk.device }}
    label: {{ disk.table }}
    state: present

- name: create device partitions
  parted:
    device: "{{ disk.device }}"
    number: "{{ item.0 }}"
    name: "{{ item.1.name }}"
    part_start: "{{ item.1.start }}"
    part_end: "{{ item.1.end }}"
    part_type: "{{ item.1.type|default(omit) }}"
    flags: "{{ item.1.flags|default(omit) }}"
    state: present
  with_indexed_items:
    - "{{ disk.partitions }}"

- name: encrypt device
  shell: >
    "echo -n {{ hostvars.localhost.luks_passphrase }} | 
    cryptsetup -q luksFormat /dev/disk/by-partlabel/{{ item.name }}"
  with_items:
    - "{{ disk.partitions }}"
  when: item.encrypt


- name: open encrypted device
  shell: >
    "echo -n {{ hostvars.localhost.luks_passphrase }} |
    cryptsetup luksOpen /dev/disk/by-partlabel/{{ item.name }} arch-{{ item.name }}"
  with_items:
    - "{{ disk.partitions }}"
  when: item.encrypt

- name: create filesystems on partitions
  filesystem:
    dev: "{{ disk.device }}{{ item.0 }}"
    fstype: "{{ item.1.filesystem }}"
  with_indexed_items:
    - "{{ disk.partitions }}"

- name: create swap
  command: "mkswap /dev/{{ lvm.group }}/{{ item.name }}"
  with_items: "{{ lvm.volumes }}"
  when: item.fstype == "linux-swap"

- name: enable swap
  command: "swapon /dev/{{ lvm.group }}/{{ item.name }}"
  with_items: "{{ lvm.volumes }}"
  when: item.fstype == "linux-swap"
